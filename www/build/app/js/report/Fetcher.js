/*! Global-Forest-Watch-Commodities - v2.0.0 - 2015-05-13/ */define(["dojo/number","dojo/Deferred","dojo/promise/all","dojo/_base/array","report/config","report/Renderer","report/RiskHelper","report/Suitability","esri/map","esri/request","esri/tasks/query","esri/dijit/Scalebar","esri/tasks/QueryTask","esri/SpatialReference","esri/geometry/Polygon","esri/tasks/GeometryService","esri/tasks/AreasAndLengthsParameters","esri/Color","esri/graphic","esri/symbols/SimpleFillSymbol"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){"use strict";var u=[];return{getAreaFromGeometry:function(c){function d(b){1===b.areas.length?(g=a.format(b.areas[0],{places:0}),report.area=b.areas[0],h.resolve(g)):(g=m,h.resolve(!1))}function f(){h.resolve(!1)}this._debug("Fetcher >>> getAreaFromGeometry");var g,h=new b,i=new p(e.geometryServiceUrl),j=new q,k=new n(54012),l=new o(c),m="Not Available";return j.areaUnit=p.UNIT_HECTARES,i.project([l],k,function(a){a.length>0?(l.rings=a[0].rings,l.setSpatialReference(k)):f(),i.simplify([l],function(a){j.polygons=a,i.areasAndLengths(j,d,f)},f)},f),h.promise},setupMap:function(){function a(){f.graphics.clear(),f.resize(),b=new l({map:f,scalebarUnit:"metric"}),d=new t,e=new o(report.geometry),c=new s(e,d),f.graphics.add(c),f.setExtent(c.geometry.getExtent().expand(3),!0)}var b,c,d,e,f;f=new i("print-map",{basemap:"topo",sliderPosition:"top-right"}),f.on("load",a)},getPrimaryForestResults:function(){this._debug("Fetcher >>> getPrimaryForestResults");var a=new b,d=e.primaryForest;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d),this._getCompositionAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getTreeCoverResults:function(){this._debug("Fetcher >>> getTreeCoverResults");var a=new b,d=e.treeCover;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d),this._getCompositionAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getTreeCoverLossResults:function(){function a(a){a.histograms.length>0?(f.renderTreeCoverLossData(a.histograms[0].counts,i.pixelSize,g),f.renderCompositionAnalysis(a.histograms[0].counts,i.pixelSize,g)):f.renderAsUnavailable("loss",g),d.resolve(!0)}function c(b){b.details&&"The requested image exceeds the size limit."===b.details[0]&&500!==i.pixelSize?(i.pixelSize=500,j._computeHistogram(h,i,a,c)):d.resolve(!1)}this._debug("Fetcher >>> getTreeCoverLossResults");var d=new b,g=e.treeCoverLoss,h=e.imageServiceUrl,i=(g.rasterId,{geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),mosaicRule:JSON.stringify(g.mosaicRule),pixelSize:report.geometry.rings.length>45?500:100,f:"json"}),j=this;return f.renderTotalLossContainer(g),f.renderCompositionAnalysisLoader(g),this._computeHistogram(h,i,a,c),d.promise},getLegalClassResults:function(){this._debug("Fetcher >>> getLegalClassResults");var a=new b,d=e.legalClass;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getIndonesiaMoratoriumResults:function(){this._debug("Fetcher >>> getProtectedAreaResults");var a=new b,d=e.indonesiaMoratorium;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d,!0),this._getClearanceAlertAnalysis(d,!0),this._getCompositionAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getProtectedAreaResults:function(){this._debug("Fetcher >>> getProtectedAreaResults");var a=new b,d=e.protectedArea;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d,!0),this._getClearanceAlertAnalysis(d,!0),this._getCompositionAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getCarbonStocksResults:function(){this._debug("Fetcher >>> getCarbonStocksResults");var a=new b,d=e.carbonStock;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getIntactForestResults:function(){this._debug("Fetcher >>> getIntactForestResults");var a=new b,d=e.intactForest;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d,!0),this._getClearanceAlertAnalysis(d,!0)]).then(function(){a.resolve(!0)}),a.promise},getLandCoverGlobalResults:function(){this._debug("Fetcher >>> getLandCoverGlobalResults");var a=new b,d=e.landCoverGlobal;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getLandCoverAsiaResults:function(){this._debug("Fetcher >>> getLandCoverAsiaResults");var a=new b,d=e.landCoverAsia;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getLandCoverIndonesiaResults:function(){this._debug("Fetcher >>> getLandCoverIndonesiaResults");var a=new b,d=e.landCoverIndo;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d),this._getClearanceAlertAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getPeatLandsResults:function(){this._debug("Fetcher >>> getPeatLandsResults");var a=new b,d=e.peatLands;return f.renderContainers(d),u.push(d),c([this._getTotalLossAnalysis(d,!0),this._getClearanceAlertAnalysis(d,!0),this._getCompositionAnalysis(d)]).then(function(){a.resolve(!0)}),a.promise},getRSPOResults:function(){function a(a){f.renderRSPOData(a,g,i),d.resolve(!0)}function c(b){b.details&&"The requested image exceeds the size limit."===b.details[0]&&500!==k.pixelSize?(k.pixelSize=500,l._computeHistogram(h,k,a,c)):d.resolve(!1)}this._debug("Fetcher >>> getRSPOResults");var d=new b,g=e.rspo,h=e.imageServiceUrl,i=this._getEncodingFunction(g.lossBounds,g.bounds),j=i.render(e.totalLoss.rasterId,g.rasterId),k={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),renderingRule:j,pixelSize:100,f:"json"},l=this;return f.renderRSPOContainer(g),this._computeHistogram(h,k,a,c),d.promise},_getTotalLossAnalysis:function(a,c){function d(b){if(b.histograms.length>0)f.renderLossData(b.histograms[0].counts,n.pixelSize,a,k,c);else{var d=Array.apply(null,new Array(i.labels.length)).map(Number.prototype.valueOf,0);f.renderLossData(d,n.pixelSize,a,k,c)}h.resolve(!0)}function g(a){a.details&&"The requested image exceeds the size limit."===a.details[0]&&500!==n.pixelSize?(n.pixelSize=500,o._computeHistogram(j,n,d,g)):h.resolve(!1)}this._debug("Fetcher >>> _getTotalLossAnalysis");var h=new b,i=e.totalLoss,j=e.imageServiceUrl,k=this._getEncodingFunction(i.bounds,a.bounds),l=a.rasterRemap?a.rasterRemap:a.rasterId,m=c?k.getSimpleRule(i.rasterId,l):k.render(i.rasterId,l),n={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),renderingRule:m,pixelSize:report.geometry.rings.length>45?500:100,f:"json"},o=this;return this._computeHistogram(j,n,d,g),h.promise},_getClearanceAlertAnalysis:function(a,c){function d(b){if(b.histograms.length>0)f.renderClearanceData(b.histograms[0].counts,j.pixelSize,a,k,c);else{var d=Array.apply(null,new Array(report.clearanceLabels.length)).map(Number.prototype.valueOf,0);f.renderClearanceData(d,j.pixelSize,a,k,c)}l.resolve(!0)}function g(){l.resolve(!1)}this._debug("Fetcher >>> _getClearanceAlertAnalysis");var h,i,j,k,l=new b,m=e.clearanceAlerts,n=e.clearanceAnalysisUrl;return a.formaId&&(a.rasterId=a.formaId,a.includeFormaIdInRemap&&(a.rasterRemap.rasterFunctionArguments.Raster=a.formaId)),k=this._getEncodingFunction(report.clearanceBounds,a.bounds),i=a.rasterRemap?a.rasterRemap:a.rasterId,h=c?k.getSimpleRule(m.rasterId,i):k.render(m.rasterId,i),j={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),renderingRule:h,pixelSize:500,f:"json"},this._computeHistogram(n,j,d,g),l.promise},_getCompositionAnalysis:function(a){function c(b){b.histograms.length>0?f.renderCompositionAnalysis(b.histograms[0].counts,j.pixelSize,a):f.renderAsUnavailable("composition",a),g.resolve(!0)}function d(a){a.details&&"The requested image exceeds the size limit."===a.details[0]&&500!==j.pixelSize?(j.pixelSize=500,k._computeHistogram(h,j,c,d)):g.resolve(!1)}f.renderCompositionAnalysisLoader(a);var g=new b,h=e.imageServiceUrl,i=a.compositionAnalysis,j={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),mosaicRule:JSON.stringify({mosaicMethod:"esriMosaicLockRaster",lockRasterIds:[i.rasterId],ascending:!0,mosaicOperation:"MT_FIRST"}),pixelSize:report.geometry.rings.length>45?500:100,f:"json"},k=this;return this._computeHistogram(h,j,c,d),g.promise},_getSuitabilityAnalysis:function(){this._debug("Fetcher >>> _getSuitabilityAnalysis");var a=new b,c=e.suitability;return f.renderSuitabilityContainer(c),h.getSuitabilityData().then(function(b){f.renderSuitabilityData(c,b),h.getCompositionAnalysis().then(function(b){f.renderSuitabilityCompositionChart(b),a.resolve(!0)})}),a.promise},_getMillPointAnalysis:function(){function a(){var a,b=new XMLHttpRequest;b.open("POST",j.url,!0),b.onreadystatechange=function(){4===b.readyState&&(200===b.status?(a=JSON.parse(b.response),l.resolve(a.mills?a.mills:!1)):l.resolve(!1))},b.addEventListener("error",function(){l.resolve(!1)},!1);var c=new FormData;c.append("mills",n.map(function(a){return a.millId}).join(",")),b.send(c)}function h(){g.prepareFeatures(m).then(function(a){g.performAnalysis(a)}),k.resolve(!1)}this._debug("Fetcher >>> _getMillPointAnalysis");var i=new b,j=e.millPoints,k=new b,l=new b,m=[],n=[];return f.renderMillContainer(j),d.forEach(report.mills,function(a){a.isCustom?m.push(a):n.push(a)}),n.length>0?a():l.resolve(),m.length>0?h():k.resolve(!1),c([k,l]).then(function(a){var b=[];d.forEach(a,function(a){a&&(b=b.concat(a))}),f.renderMillAssessment(b,j),i.resolve(!0)}),i.promise},_getFireAlertAnalysis:function(){this._debug("Fetcher >>> _getFireAlertAnalysis");var a,d,g,h,i=new b,j=new o(report.geometry),l=new Date,n="";return d=new k,h=new m(e.fires.url+"/4"),d.geometry=j,d.returnGeometry=!1,d.outFields=["*"],d.where="1 = 1",g=new m("http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer/0"),a=new k,a.geometry=j,a.returnGeometry=!1,a.outFields=["moratorium"],l.setDate(l.getDate()-8),n=l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()+" "+l.getHours()+":"+l.getMinutes()+":"+l.getSeconds(),a.where="ACQ_DATE > date '"+n+"'",c([h.execute(d),g.execute(a)]).then(function(a){f.renderFireData(u,a),i.resolve(!0)}),h.on("error",function(){i.resolve(!1)}),i.promise},_getClearanceBounds:function(){this._debug("Fetcher >>> _getClearanceBounds");var a,c,d=e.clearanceBounds,f=new b,g=0;return c=j({url:d.url,content:{f:"pjson"},handleAs:"json",callbackParamName:"callback"}),c.then(function(b){report.clearanceBounds=[b.minValues[0],b.maxValues[0]],report.clearanceLabels=[];for(var c=b.minValues[0],e=b.maxValues[0];e>=c;c++)a=c%12===0?12:c%12,report.clearanceLabels.push(a+"-"+(d.baseYearLabel+g)),c%12===0&&++g;f.resolve(!0)},function(a){f.resolve(!1,a)}),f.promise},_getEncodingFunction:function(a,b){return{A:a.fromBounds(),B:b.fromBounds(),getSimpleRule:function(a,b){return JSON.stringify({rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:a,Raster2:b,Operation:3}})},renderRule:function(a,b){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:[this.A[0],this.A[this.A.length-1]+1],OutputValues:[this.B.length],Raster:a,AllowUnmatched:!1}},Raster2:a,Operation:3}},Raster2:b,Operation:1}}},render:function(a,b){return JSON.stringify(this.renderRule(a,b))},encode:function(a,b){return this.B.length*a+b},decode:function(a){var b=a%this.B.length,c=(a-b)/this.B.length;return[c,b]}}},_computeHistogram:function(a,b,c,d){var e=j({url:a+"/computeHistograms",content:b,handleAs:"json",callbackParamName:"callback",timeout:6e4},{usePost:!0});e.then(c,d)},_debug:function(a){console.log(a)}}});