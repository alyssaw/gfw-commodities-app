/*! Global-Forest-Watch-Commodities - v2.0.0 - 2015-03-18/ */define(["report/config","dojo/number","dijit/Dialog","dojo/_base/array","dojo/on","dojo/dom","dojo/dom-style"],function(a,b,c,d){"use strict";return{renderContainers:function(a){var b=document.createDocumentFragment(),c=document.createElement("div"),d=document.getElementById("print-map");c.id=a.rootNode,c.className="result-container",c.innerHTML="<div class='title'>"+a.title+"</div><div class='result-block total-loss'><div class='top-panel' id='"+a.rootNode+"_composition'></div><div class='left-panel'><div class='loss-chart' id='"+a.rootNode+"_loss'><div class='loader-wheel'>total loss</div></div></div><div class='right-panel'><div class='fires-chart' id='"+a.rootNode+"_fire'><div class='loader-wheel'>active fires</div></div></div></div><div class='result-block clearance-alerts'><div class='clearance-chart' id='"+a.rootNode+"_clearance'><div class='loader-wheel'>clearance alerts</div></div></div><div class='result-block mill-points'><div class='mill-table' id='"+a.rootNode+"_mill'></div></div>",b.appendChild(c),document.getElementById("report-results-section").insertBefore(b,d)},renderTotalLossContainer:function(a){var b=document.createDocumentFragment(),c=document.createElement("div"),d=document.getElementById("print-map");c.id=a.rootNode,c.className="result-container",c.innerHTML="<div class='title'>"+a.title+"</div><div class='result-block total-loss'><div class='top-panel' id='"+a.rootNode+"_composition'></div><div class='left-panel'><div class='loss-chart' id='"+a.rootNode+"_loss'><div class='loader-wheel'>total loss</div></div></div></div>",b.appendChild(c),document.getElementById("report-results-section").insertBefore(b,d)},renderRSPOContainer:function(a){var b=document.createDocumentFragment(),c=document.createElement("div"),d=document.getElementById("print-map");c.id=a.rootNode,c.className="result-container",c.innerHTML="<div class='title'>"+a.title+"</div><div class='rspo-table-container' id='"+a.rootNode+"_table'><div class='loader-wheel'>rspo analysis</div></div><div class='rspo-chart-container' id='"+a.rootNode+"_chart'></div>",b.appendChild(c),document.getElementById("report-results-section").insertBefore(b,d)},renderSuitabilityContainer:function(a){var b=document.createDocumentFragment(),c=document.createElement("div"),d=document.getElementById("print-map");c.id=a.rootNode,c.className="result-container",c.innerHTML="<div class='title'>"+a.title+"</div><div class='suitability-container'><div class='left-panel'><div id='"+a.rootNode+"_content' class='suitability-content'><div class='loader-wheel'>suitability</div></div></div><div class='right-panel'><div id='"+a.rootNode+"_chart' class='suitability-chart'><div class='loader-wheel'>suitability</div></div></div></div>",b.appendChild(c),document.getElementById("report-results-section").insertBefore(b,d)},renderMillContainer:function(a){var b=document.createDocumentFragment(),c=document.createElement("div"),d=document.getElementById("print-map");c.id=a.rootNode,c.className="result-container relative",c.innerHTML="<div class='title'>"+a.title+"</div><div class='mill-table-container' id='"+a.rootNode+"_table'><div class='loader-wheel'>risk assessment</div></div>",b.appendChild(c),document.getElementById("report-results-section").insertBefore(b,d)},renderCompositionAnalysisLoader:function(a){document.getElementById(a.rootNode+"_composition").innerHTML='<div class="loader-wheel">composition analysis</div>'},renderCompositionAnalysis:function(a,c,d){var e,f,g,h=document.createDocumentFragment(),i=document.createElement("div"),j=document.getElementById(d.rootNode+"_composition"),k=d.compositionAnalysis,l=k.title||d.title;k.histogramSlice&&(g=a.slice(k.histogramSlice)),g=g.reduce(function(a,b){return a+b})*c*c/1e4,e=b.format(g),report.areaPromise.then(function(){f=b.format(g/report.area*100,{places:0}),i.className="composition-analysis-container",i.innerHTML="<div>Total "+l+" in selected area: "+e+" ha</div><div>Percent of total area comprised of "+l+": "+f+"%</div>",h.appendChild(i),j.innerHTML="",j.appendChild(h)})},renderLossData:function(b,c,e,f,g){var h,i,j,k,l,m=a.totalLoss,n=e.labels,o=m.labels,p=e.bounds.fromBounds(),q=m.bounds.fromBounds(),r=function(a){return a*c*c/1e4},s=[],t=[];if(g)s.push({name:n[0],data:b.slice(1).map(r)}),t.push(e.colors[0]);else for(k=0;k<p.length;k++){for(j=[],l=0;l<q.length;l++)h=f.encode(q[l],p[k]),j.push(b[h]||0);s.push({name:n[k],data:j.map(r)}),t.push(e.colors[k])}e.lossChart.removeBelowYear&&(i=o.indexOf(e.lossChart.removeBelowYear),o=o.slice(i),d.forEach(s,function(a){a.data=a.data.slice(i)})),$("#"+e.rootNode+"_loss").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null,type:"bar",events:{load:function(){}}},colors:t,title:{text:e.lossChart.title},xAxis:{categories:o,maxPadding:.35,title:{text:null}},yAxis:{stackLabels:{enabled:!0},title:{text:null}},legend:{enabled:!0,verticalAlign:"bottom"},plotOptions:{series:{stacking:"normal"}},series:s,credits:{enabled:!1}})},renderTreeCoverLossData:function(b,c,e){var f,g=a.totalLoss,h=e.labels,i=g.labels,j=(e.bounds.fromBounds(),g.bounds.fromBounds(),function(a){return a*c*c/1e4}),k=[],l=[];k.push({name:h[0],data:b.slice(1).map(j)}),l.push(e.color),e.lossChart.removeBelowYear&&(f=i.indexOf(e.lossChart.removeBelowYear),i=i.slice(f),d.forEach(k,function(a){a.data=a.data.slice(f)})),$("#"+e.rootNode+"_loss").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null,type:"bar",events:{load:function(){}}},colors:l,title:{text:e.lossChart.title},xAxis:{categories:i,maxPadding:.35,title:{text:null}},yAxis:{stackLabels:{enabled:!0},title:{text:null}},legend:{enabled:!1,verticalAlign:"bottom"},plotOptions:{series:{stacking:"normal"}},series:k,credits:{enabled:!1}})},renderClearanceData:function(a,b,c,d,e){var f,g,h,i,j=c.labels,k=c.bounds.fromBounds(),l=report.clearanceBounds.fromBounds(),m=[],n=[];if("pie"===c.clearanceChart.type){for(h=0;h<k.length;h++){for(g=0,n=[],i=0;i<l.length;i++)f=d.encode(l[i],k[h]),n.push(a[f]||0);m.push({name:j[h],data:n})}if(0===m.length)return void this.renderAsUnavailable("clearance",c);$("#"+c.rootNode+"_clearance").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},colors:c.colors,title:{text:c.clearanceChart.title},xAxis:{categories:report.clearanceLabels},yAxis:{title:null,min:0},legend:{enabled:!0},credits:{enabled:!1},series:m})}else{if(e)m=a.slice(1);else for(h=0;h<l.length;h++){for(g=0,i=0;i<k.length;i++)f=d.encode(l[h],k[i]),g+=a[f]||0;m.push(g)}if(0===m.length)return void this.renderAsUnavailable("clearance",c);$("#"+c.rootNode+"_clearance").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},colors:["#fb00b3"],title:{text:c.clearanceChart.title},xAxis:{categories:report.clearanceLabels},yAxis:{title:null,min:0},legend:{enabled:!1},credits:{enabled:!1},series:[{name:c.title,data:m}]})}},renderFireData:function(c,e){function f(a,c,d,e){var f=document.createDocumentFragment(),g=document.createElement("div"),h=document.getElementById(a+"_fire");g.className="active-fires-badge",g.innerHTML="<div>There are currently</div><div class='active-fires-label'><div>"+b.format(c)+"</div><span>active fires</span></div><div>"+e+"</div><div class='total-active-fires-label'><span>"+b.format(d)+" total active fires</span></div>",f.appendChild(g),h.innerHTML="",h.appendChild(f)}function g(a,c,d,e,f){for(var g=document.createDocumentFragment(),h=document.createElement("div"),i=document.getElementById(a+"_fire"),j=[],k=0;k<c.length;k++)k>=d[0]&&k<=d[1]&&j.push(c[k]);h.className="active-fires-badge special",h.innerHTML="<div>Active fires are detected in:</div><div class='active-fires-label'><span>"+e[0]+" Forests</span><div>"+b.format(j[0]||0)+"</div></div><div class='active-fires-label'><span>"+e[1]+" Forests</span><div>"+b.format(j[1]||0)+"</div></div><div class='total-active-fires-label'><span>out of "+b.format(f)+" total active fires</span></div></div>",g.appendChild(h),i.innerHTML="",i.appendChild(g)}function h(a,b,c,d,e,h,i){var j,k=[],l=0,m=[];for(j=0;j<b.length;j++)j>=e[0]&&j<=e[1]&&(0===b[j]||isNaN(b[j])||(k.push([c[l],b[j]]),m.push(d[l])),l++);0===k.length?f(a,0,0,i):2===c.length?g(a,b,e,c,n.length):$("#"+a+"_fire").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null},colors:m,title:{text:"Active Fires"},plotOptions:{pie:{size:"75%",allowPointSelect:!0,cursor:"pointer",showInLegend:!0,dataLabels:{enabled:!1}}},credits:{enabled:!0},legend:{enabled:!1},series:[{type:"pie",name:"Fires",data:k}]})}var i,j,k,l,m,n=e[0].features.concat(e[1].features);d.forEach(c,function(b){if(k=b.rootNode,l=a.fires[b.fireKey],0===n.length)f(k,0,0,l.badgeDesc);else if("pie"===l.type){for(j=[],m=0;m<=l.labels.length;m++)j[m]=0;d.forEach(n,function(a){j[a.attributes[l.field]]++}),h(k,j,l.labels,l.colors,l.bounds,l.title,l.badgeDesc)}else i=0,d.forEach(n,function(a){i+=isNaN(parseInt(a.attributes[l.field]))?0:parseInt(a.attributes[l.field])}),f(k,i,n.length,l.badgeDesc)})},renderRSPOData:function(c,d,e){var f=a.rspo.lossBounds.fromBounds();if(!(c.histograms.length>0))return void(document.getElementById(d.rootNode+"_table").innerHTML="<div class='data-not-available'>No RSPO Data Available for this Site.</div>");var g,h,i,j,k,l,m,n,o=2005,p=7,q="",r="",s="",t="",u="",v=[],w=[],x=[],y=[],z=[];for(q="<table class='rspo-results-table'><tr><th>Forest Type</th>",i=0;p>=i;i++)v.push(o+i),q+="<th>"+(o+i)+"</th>";for(q+="</tr>",h=c.histograms[0].counts,j=0;j<f.length;j++)g=e.encode(f[j],2),x.push(h[g]);for(k=0;k<f.length;k++)g=e.encode(f[k],3),y.push(h[g]);for(l=0;l<f.length;l++)g=e.encode(f[l],1),w.push(h[g]);for(m=0;m<f.length;m++)g=e.encode(f[m],0),z.push(h[g]);for(s="<tr><td>Primary</td>",t="<tr><td>Secondary</td>",r="<tr><td>Agroforestry</td>",u="<tr><td>Non-Forest</td>",n=0;n<x.length;n++)s+="<td>"+(b.format(x[n])||"N/A")+"</td>",t+="<td>"+(b.format(y[n])||"N/A")+"</td>",r+="<td>"+(b.format(w[n])||"N/A")+"</td>",u+="<td>"+(b.format(z[n])||"N/A")+"</td>";s+="</tr>",t+="</tr>",r+="</tr>",u+="</tr>",q+=s+t+r+u+"</table>",q+="<div class='change-area-unit'>(Change in Hectares)</div>",document.getElementById(d.rootNode+"_table").innerHTML=q,this.renderRSPOChart(d,x,y,w,z,v)},renderRSPOChart:function(a,c,d,e,f,g){var h={color:"#000"},i={style:h};$("#"+a.rootNode+"_chart").highcharts({chart:{backgroundColor:"#FFF",type:"column"},colors:a.colors,title:{text:null},legend:{align:"center",verticalAlign:"top",enabled:!0},xAxis:{categories:g,labels:i},yAxis:{title:{text:"",style:h},labels:i},plotOptions:{column:{stacking:"normal"}},tooltip:{formatter:function(){return"<strong>"+this.key+"</strong><br/>"+this.series.name+": "+b.format(this.y)+"<br/>Total: "+b.format(this.point.stackTotal)}},credits:{enabled:!1},series:[{name:"Primary",data:c},{name:"Secondary",data:d},{name:"Agroforestry",data:e},{name:"Non-Forest",data:f}]})},renderSuitabilityData:function(a,c){var d,e,f,g,h,i,j,k,l,m=a.lcHistogram.classIndices,n="<table>";if(l=c[0],l?(d=Math.pow(l.pixelSize/100,2),l.data.counts[1]?(f=b.format(l.data.counts[1]*d)||l.data.counts[1],e=b.format(l.data.counts[0]*d)||l.data.counts[0]):(f=0,e=b.format(l.data.counts[0]*d))):(f="N/A",e="N/A"),l=c[1]){d=Math.pow(l.pixelSize/100,2);var o=function(a){for(var c=0,e=0;e<a.length;e++)l.data.counts[a[e]]&&(c+=l.data.counts[a[e]]*d);return b.format(c)};i=o(m.production),j=o(m.convertible),k=o(m.other)}else i="N/A",j="N/A",k="N/A";l=c[2],g=l?parseFloat(l.data.min/1e3).toFixed(1):"N/A",l=c[3],h=l?l.value:"N/A",n+="<tr><td>Suitable(ha):</td><td>"+f+"</td></tr>",n+="<tr><td>Unsuitable(ha):</td><td>"+e+"</td></tr>",n+="<tr><td>Distance to nearest road(km):</td><td>"+g+"</td></tr>",n+="<tr><td>Existing concessions(Yes/No):</td><td>"+h+"</td></tr>",n+="<tr><td>Legal Classification(ha):</td><td></td></tr>",n+="<tr><td class='child-row'>Production forest(HP/HPT):</td><td>"+i+"</td></tr>",n+="<tr><td class='child-row'>Convertible forest(HPK):</td><td>"+j+"</td></tr>",n+="<tr><td class='child-row'>Other land uses(APL):</td><td>"+k+"</td></tr>",n+="</table>",n+="<p>"+a.localRights.content+"</p>",n+="<div class='field-assessment-link'><a href='"+a.localRights.fieldAssessmentUrl+"'>"+a.localRights.fieldAssessmentLabel+"</a></div>",document.getElementById(a.rootNode+"_content").innerHTML=n,this.renderSuitabilityChart(a,c[4])},renderSuitabilityChart:function(a,b){function c(a){for(var c={suitable:0,unsuitable:0},d=0;d<a.length;d++)b.data.counts[a[d]]&&(c.unsuitable+=b.data.counts[a[d]]*h,c.suitable+=b.data.counts[a[d]+10]*h);return c}if(!b)return void(document.getElementById(a.rootNode+"_chart").innerHTML="<div class='data-not-available'>No Suitability Data Available to chart for this Site.</div>");var d,e,f,g=a.lcHistogram.classIndices,h=Math.pow(b.pixelSize/100,2),i=a.chart,j=[],k=[],l=[];d=c(g.convertible),e=c(g.production),f=c(g.other),j.push({y:d.suitable+e.suitable+f.suitable,color:i.suitable.color,name:i.suitable.name,id:i.suitable.id,children:{categories:i.childrenLabels,colors:i.childrenColors,data:[e.suitable,d.suitable,f.suitable]}}),j.push({y:d.unsuitable+e.unsuitable+f.unsuitable,color:i.unsuitable.color,name:i.unsuitable.name,id:i.unsuitable.id,children:{categories:i.childrenLabels,colors:i.childrenColors,data:[e.unsuitable,d.unsuitable,f.unsuitable]}});for(var m=0;m<j.length;m++)if(j[m].y>0){k.push({color:j[m].color,name:j[m].name,id:j[m].id,y:j[m].y});for(var n=0;n<j[m].children.data.length;n++)j[m].children.data[n]>0&&l.push({name:j[m].children.categories[n],color:j[m].children.colors[n],y:j[m].children.data[n],parentId:j[m].id})}$("#"+a.rootNode+"_chart").highcharts({chart:{type:"pie",backgroundColor:"#FFF",plotBorderWidth:null},title:{text:i.title},tooltip:{valueSuffix:""},plotOptions:{series:{point:{events:{legendItemClick:function(){var a=this.id,b=this.series.chart.series[1].data;b.forEach(function(b){b.parentId===a&&b.setVisible(b.visible?!1:!0)})}}}}},legend:{itemStyle:{color:"#000"}},credits:{enabled:!1},series:[{name:"Area",data:k,size:"60%",showInLegend:!0,dataLabels:{enabled:!1}},{name:"Legal Area",data:l,size:"80%",innerSize:"60%",dataLabels:{color:"black",distance:5}}]})},renderMillAssessment:function(a,b){function c(a,b,c,d){var e=c?"data-row parent":"data-row";e+=d?" child "+d:"";var f="<tr class='"+e+"' "+(c?"data-class='"+c+"'":"")+"><td class='row-name'>"+(c?"<span class='toggle-icon'></span>":"")+"<span>"+a+"</span></td>";return f+="<td class='"+b.concession.risk+"'><span class='large-swatch'></span><span class='risk-label'>"+b.concession.risk+"</span></td>",f+="<td>"+b.concession.raw+"</td>",f+="<td class='"+b.radius.risk+"'><span class='large-swatch'></span><span class='risk-label'>"+b.radius.risk+"</span></td>",f+="<td>"+b.radius.raw+"</td>",f+="</tr>"}function e(){var a=$(".toggle-button-container"),b=a.hasClass("active")?2:1;a.toggleClass("active"),$(".mill-table-container tr.data-row td:nth-child(3)").toggle(),$(".mill-table-container tr.data-row td:nth-child(5)").toggle(),$(".mill-table-container tr.data-row td:nth-child(2)").attr("colspan",b),$(".mill-table-container tr.data-row td:nth-child(4)").attr("colspan",b)}function f(a){var b=a.currentTarget,c=b.dataset?b.dataset["class"]:b.getAttribute("data-class");$(".mill-table-container .data-row.child."+c).toggle(),$(b).toggleClass("open")}var g,h=[],i="<div id='value-toggle' class='value-toggle'><span class='toggle-label'>Show Values</span><span class='toggle-button-container active'><span class='toggle-knob'></span></span></div>",j="";d.forEach(a,function(a){report.mills?(d.some(report.mills,function(b){return a.id===b.id?(g=b.label,!0):void 0}),void 0===g&&(g=window.payload.title)):g=window.payload.title,j="<div class='mill-header'><span class='mill-title'>"+window.payload.title+"</span><span class='mill-risk-level "+a.risk+"'><span class='large-swatch'></span>Total Mill Risk Level: <span class='overall-risk'>"+a.risk+"</span></span></div>",j+="<table><tr><th></th><th colspan='2'>Concession<span class='info-icon' data-type='concession'></span></th><th colspan='2'>Radius<span class='info-icon' data-type='radius'></span></th></tr>",j+=c("Total tree cover loss",a.deforestation.umd_loss,null,"deforest-"+a.id),j+=c("Tree cover loss on primary forest",a.deforestation.umd_loss_primary,null,"deforest-"+a.id),j+=c("Total clearance alerts",a.deforestation.forma,null,"deforest-"+a.id),j+=c("Clearance alerts on primary forest",a.deforestation.forma_primary,null,"deforest-"+a.id),j+=c("Tree cover loss on carbon stock",a.deforestation.carbon,null,"deforest-"+a.id),j+=c("Legality",a.legal),j+=c("Presence of peat",a.peat.presence,null,"peat-"+a.id),j+=c("Clearance on peat",a.peat.clearance,null,"peat-"+a.id),j+=c("Fires",a.fire),j+="</table>",h.push(j)}),document.getElementById(b.rootNode+"_table").innerHTML=i+h.join("<br />"),$("#value-toggle").click(e),$(".mill-table-container tr.parent").click(f),$(".mill-table-container .info-icon").click(this.showMillPointInfo),$(".mill-table-container .data-row.child").toggle()},showMillPointInfo:function(b){var d,e=b.currentTarget,f=e.dataset?e.dataset.type:e.getAttribute("data-type"),g=a.millPointInfo[f];d=new c({title:g.title,content:g.content,style:"width: 300px;"}),d.show()},renderAsUnavailable:function(a,b){var c=document.getElementById(b.rootNode+"_"+a),d="";d="loss"===a?"No Tree Cover Loss Data Available for this site.":"clearance"===a?"No Clearance Alert Data Available for this site.":"composition"===a?"No Composition Analysis Data Available for this site.":"No Mill Point Data Available for this site.",c&&(c.innerHTML=d)}}});