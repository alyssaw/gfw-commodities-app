/*! Global-Forest-Watch-Commodities - v2.0.0 - 2015-05-13/ */define(["report/config","dojo/Deferred","dojo/promise/all","dojo/_base/array","esri/tasks/query","esri/tasks/QueryTask","report/riskController","esri/geometry/geometryEngine"],function(a,b,c,d,e,f,g,h){"use strict";var i={prepareFeatures:function(a){var e=new b,f=[],g=this;return d.forEach(a,function(a){var c=new b;g.getAreaAndIndoIntersect(a).then(function(a){c.resolve({feature:a.feature,area:a.area,inIndonesia:a.inIndonesia})}),f.push(c.promise)}),c(f).then(function(a){e.resolve(a)}),e.promise},getAreaAndIndoIntersect:function(a){var c=new b,d=this.getArea(a.geometry);return this.getIntersectionStatus(a).then(function(b){c.resolve({feature:a,area:d,inIndonesia:b})}),c.promise},getArea:function(a){var b=h.simplify(a);return h.planarArea(b)},getIntersectionStatus:function(c){var d,g,i=new b;return g=new f(a.boundariesUrl),d=new e,d.returnGeometry=!0,d.outFields=["OBJECTID"],d.where="ISO3 = 'IDN'",d.geometryPrecision=1,g.execute(d,function(a){var b=a.features[0]&&a.features[0].geometry;i.resolve(h.contains(b,c.geometry))},function(){i.resolve(!1)}),i.promise},performAnalysis:function(a){var e,f,h,i,j=this,k=[];d.forEach(a,function(a){var d=new b;i=a.feature.isRSPO||!1,f=a.feature.geometry,e=a.inIndonesia,h=a.area,c([g(f,h,"concession",i,e),g(f,h,"radius",i,e)]).then(function(b){d.resolve({feature:a.feature,results:b})}),k.push(d)}),c(k).then(function(a){console.log(j);var b=j.formatData(a);console.log(b)})},formatData:function(a){function b(a,b){var c;switch(a.label){case"Legality":f.legal[b]={risk:h[a.risk]};break;case"RSPO":f.rspo.risk=void 0!==a.risk?a.risk:!1;break;case"Fires":f.fire[b]={risk:h[a.risk]};break;case"Carbon":break;case"Peat":c="concession"===b?"peat_concession":"peat_radius",f.peat[c]=h[a.risk];break;case"Deforestation":c="concession"===b?"deforestation_concession":"deforestation_radius",f.deforestation[c]=h[a.risk]}}var c,e,f,g=[],h={1:"low",2:"medium",3:"high"};return d.forEach(a,function(a){c=a.results[0],e=a.results[1],f={deforestation:{},fire:{},legal:{},peat:{},rspo:{},priority_level_concession:"",priority_level_radius:"",total_mill_priority_level:""},d.forEach(c,function(a){b(a,"concession")}),d.forEach(e,function(a){b(a,"radius")}),g.push(f)}),g}};return i});